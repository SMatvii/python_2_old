{% extends "base.html" %}

{% block title %}–¢–µ—Å—Ç - –®–∫—ñ–ª—å–Ω–∏–π —Ä–æ–∑–∫–ª–∞–¥{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-lg-10">
        <div class="card">
            <div class="card-header text-center">
                <h2>üß† –ó–∞–≥–∞–ª—å–Ω–∏–π —Ç–µ—Å—Ç –∑–Ω–∞–Ω—å</h2>
                <p class="mb-0">–ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ —Å–≤–æ—ó –∑–Ω–∞–Ω–Ω—è –∑ —Ä—ñ–∑–Ω–∏—Ö –ø—Ä–µ–¥–º–µ—Ç—ñ–≤</p>
            </div>
            <div class="card-body">
                
                <div id="instructions" class="text-center mb-4">
                    <div class="alert alert-info">
                        <h5>üìã –Ü–Ω—Å—Ç—Ä—É–∫—Ü—ñ—ó –¥–æ —Ç–µ—Å—Ç—É</h5>
                        <ul class="list-unstyled">
                            <li>‚Ä¢ –¢–µ—Å—Ç –º—ñ—Å—Ç–∏—Ç—å 10 –∑–∞–ø–∏—Ç–∞–Ω—å –∑ —Ä—ñ–∑–Ω–∏—Ö –ø—Ä–µ–¥–º–µ—Ç—ñ–≤</li>
                            <li>‚Ä¢ –ù–∞ –∫–æ–∂–Ω–µ –∑–∞–ø–∏—Ç–∞–Ω–Ω—è —î 4 –≤–∞—Ä—ñ–∞–Ω—Ç–∏ –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ</li>
                            <li>‚Ä¢ –û–±–µ—Ä—ñ—Ç—å –æ–¥–∏–Ω –ø—Ä–∞–≤–∏–ª—å–Ω–∏–π –≤–∞—Ä—ñ–∞–Ω—Ç</li>
                            <li>‚Ä¢ –ü—ñ—Å–ª—è –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—è –≤–∏ –ø–æ–±–∞—á–∏—Ç–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç</li>
                            {% if session.user_id %}
                                <li>‚Ä¢ –í–∞—à —Ä–µ–∑—É–ª—å—Ç–∞—Ç –±—É–¥–µ –∑–±–µ—Ä–µ–∂–µ–Ω–æ –≤ —Å–∏—Å—Ç–µ–º—ñ</li>
                            {% else %}
                                <li>‚Ä¢ –ó–∞—Ä–µ—î—Å—Ç—Ä—É–π—Ç–µ—Å—è, —â–æ–± –∑–±–µ—Ä–µ–≥—Ç–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç</li>
                            {% endif %}
                        </ul>
                    </div>
                    <button class="btn btn-primary btn-lg" onclick="startTest()">
                        üöÄ –†–æ–∑–ø–æ—á–∞—Ç–∏ —Ç–µ—Å—Ç
                    </button>
                </div>

                <div id="testContainer" style="display: none;">
                    <div class="progress mb-4">
                        <div id="progressBar" class="progress-bar" role="progressbar" 
                             style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
                            0/10
                        </div>
                    </div>

                    <div id="questionContainer">
                    </div>

                    <div class="d-flex justify-content-between mt-4">
                        <button id="prevBtn" class="btn btn-secondary" onclick="previousQuestion()" style="display: none;">
                            ‚¨ÖÔ∏è –ü–æ–ø–µ—Ä–µ–¥–Ω—î
                        </button>
                        <button id="nextBtn" class="btn btn-primary" onclick="nextQuestion()">
                            –ù–∞—Å—Ç—É–ø–Ω–µ ‚û°Ô∏è
                        </button>
                        <button id="finishBtn" class="btn btn-success" onclick="finishTest()" style="display: none;">
                            ‚úÖ –ó–∞–≤–µ—Ä—à–∏—Ç–∏ —Ç–µ—Å—Ç
                        </button>
                    </div>
                </div>

                <div id="resultsContainer" style="display: none;">
                    <div class="text-center">
                        <h3>üéâ –¢–µ—Å—Ç –∑–∞–≤–µ—Ä—à–µ–Ω–æ!</h3>
                        <div id="scoreDisplay" class="mt-3"></div>
                        <div id="detailedResults" class="mt-4"></div>
                        <button class="btn btn-primary mt-3" onclick="retakeTest()">
                            üîÑ –ü—Ä–æ–π—Ç–∏ —â–µ —Ä–∞–∑
                        </button>
                        <a href="{{ url_for('index') }}" class="btn btn-secondary mt-3">
                            üè† –ù–∞ –≥–æ–ª–æ–≤–Ω—É
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
const questions = [
    {
        subject: "–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞",
        question: "–ß–æ–º—É –¥–æ—Ä—ñ–≤–Ω—é—î –∫–æ—Ä—ñ–Ω—å —ñ–∑ 144?",
        options: ["12", "14", "16", "10"],
        correct: 0
    },
    {
        subject: "–£–∫—Ä–∞—ó–Ω—Å—å–∫–∞ –º–æ–≤–∞",
        question: "–°–∫—ñ–ª—å–∫–∏ –≤—ñ–¥–º—ñ–Ω–∫—ñ–≤ –≤ —É–∫—Ä–∞—ó–Ω—Å—å–∫—ñ–π –º–æ–≤—ñ?",
        options: ["5", "6", "7", "8"],
        correct: 2
    },
    {
        subject: "–ì–µ–æ–≥—Ä–∞—Ñ—ñ—è",
        question: "–Ø–∫–∞ –Ω–∞–π–≤–∏—â–∞ –≥–æ—Ä–∞ –≤ –£–∫—Ä–∞—ó–Ω—ñ?",
        options: ["–ì–æ–≤–µ—Ä–ª–∞", "–ü–µ—Ç—Ä–æ—Å", "–ü—ñ–ø –Ü–≤–∞–Ω", "–ß–æ—Ä–Ω–æ–≥–æ—Ä–∞"],
        correct: 0
    },
    {
        subject: "–Ü—Å—Ç–æ—Ä—ñ—è",
        question: "–í —è–∫–æ–º—É —Ä–æ—Ü—ñ –£–∫—Ä–∞—ó–Ω–∞ –æ—Ç—Ä–∏–º–∞–ª–∞ –Ω–µ–∑–∞–ª–µ–∂–Ω—ñ—Å—Ç—å?",
        options: ["1990", "1991", "1992", "1993"],
        correct: 1
    },
    {
        subject: "–§—ñ–∑–∏–∫–∞",
        question: "–û–¥–∏–Ω–∏—Ü–µ—é –≤–∏–º—ñ—Ä—é–≤–∞–Ω–Ω—è —Å–∏–ª–∏ —î:",
        options: ["–î–∂–æ—É–ª—å", "–í–∞—Ç—Ç", "–ù—å—é—Ç–æ–Ω", "–ü–∞—Å–∫–∞–ª—å"],
        correct: 2
    },
    {
        subject: "–•—ñ–º—ñ—è",
        question: "–•—ñ–º—ñ—á–Ω–∏–π —Å–∏–º–≤–æ–ª –∫–∏—Å–Ω—é:",
        options: ["O", "Ox", "K", "H"],
        correct: 0
    },
    {
        subject: "–ë—ñ–æ–ª–æ–≥—ñ—è",
        question: "–°–∫—ñ–ª—å–∫–∏ –∫–∞–º–µ—Ä –º–∞—î —Å–µ—Ä—Ü–µ –ª—é–¥–∏–Ω–∏?",
        options: ["2", "3", "4", "5"],
        correct: 2
    },
    {
        subject: "–ê–Ω–≥–ª—ñ–π—Å—å–∫–∞ –º–æ–≤–∞",
        question: "–Ø–∫ –∞–Ω–≥–ª—ñ–π—Å—å–∫–æ—é –º–æ–≤–æ—é –±—É–¥–µ '–∫–Ω–∏–≥–∞'?",
        options: ["Book", "Look", "Cook", "Hook"],
        correct: 0
    },
    {
        subject: "–Ü–Ω—Ñ–æ—Ä–º–∞—Ç–∏–∫–∞",
        question: "–©–æ —Ç–∞–∫–µ HTML?",
        options: [
            "–ú–æ–≤–∞ –ø—Ä–æ–≥—Ä–∞–º—É–≤–∞–Ω–Ω—è", 
            "–ú–æ–≤–∞ —Ä–æ–∑–º—ñ—Ç–∫–∏", 
            "–ë–∞–∑–∞ –¥–∞–Ω–∏—Ö", 
            "–û–ø–µ—Ä–∞—Ü—ñ–π–Ω–∞ —Å–∏—Å—Ç–µ–º–∞"
        ],
        correct: 1
    },
    {
        subject: "–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞",
        question: "–ß–æ–º—É –¥–æ—Ä—ñ–≤–Ω—é—î 15% –≤—ñ–¥ 200?",
        options: ["25", "30", "35", "40"],
        correct: 1
    }
];

let currentQuestion = 0;
let userAnswers = [];
let startTime = null;

function startTest() {
    document.getElementById('instructions').style.display = 'none';
    document.getElementById('testContainer').style.display = 'block';
    startTime = new Date();
    currentQuestion = 0;
    userAnswers = [];
    showQuestion();
}

function showQuestion() {
    const question = questions[currentQuestion];
    const container = document.getElementById('questionContainer');
    
    container.innerHTML = `
        <div class="card">
            <div class="card-header">
                <div class="d-flex justify-content-between align-items-center">
                    <span class="badge bg-secondary">${question.subject}</span>
                    <span class="text-muted">–ó–∞–ø–∏—Ç–∞–Ω–Ω—è ${currentQuestion + 1} –∑ ${questions.length}</span>
                </div>
            </div>
            <div class="card-body">
                <h5 class="card-title">${question.question}</h5>
                <div class="mt-3">
                    ${question.options.map((option, index) => `
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="radio" 
                                   name="answer" value="${index}" id="option${index}"
                                   ${userAnswers[currentQuestion] === index ? 'checked' : ''}>
                            <label class="form-check-label" for="option${index}">
                                ${option}
                            </label>
                        </div>
                    `).join('')}
                </div>
            </div>
        </div>
    `;
    
    updateProgress();
    updateButtons();
}

function updateProgress() {
    const progress = ((currentQuestion + 1) / questions.length) * 100;
    const progressBar = document.getElementById('progressBar');
    progressBar.style.width = progress + '%';
    progressBar.textContent = `${currentQuestion + 1}/${questions.length}`;
}

function updateButtons() {
    const prevBtn = document.getElementById('prevBtn');
    const nextBtn = document.getElementById('nextBtn');
    const finishBtn = document.getElementById('finishBtn');
    
    prevBtn.style.display = currentQuestion > 0 ? 'block' : 'none';
    
    if (currentQuestion === questions.length - 1) {
        nextBtn.style.display = 'none';
        finishBtn.style.display = 'block';
    } else {
        nextBtn.style.display = 'block';
        finishBtn.style.display = 'none';
    }
}

function nextQuestion() {
    saveCurrentAnswer();
    if (currentQuestion < questions.length - 1) {
        currentQuestion++;
        showQuestion();
    }
}

function previousQuestion() {
    saveCurrentAnswer();
    if (currentQuestion > 0) {
        currentQuestion--;
        showQuestion();
    }
}

function saveCurrentAnswer() {
    const selectedOption = document.querySelector('input[name="answer"]:checked');
    if (selectedOption) {
        userAnswers[currentQuestion] = parseInt(selectedOption.value);
    }
}

function finishTest() {
    saveCurrentAnswer();
    
    const endTime = new Date();
    const timeSpent = Math.round((endTime - startTime) / 1000); // –≤ —Å–µ–∫—É–Ω–¥–∞—Ö
    
    let score = 0;
    const results = [];
    
    for (let i = 0; i < questions.length; i++) {
        const isCorrect = userAnswers[i] === questions[i].correct;
        if (isCorrect) score++;
        
        results.push({
            question: questions[i].question,
            subject: questions[i].subject,
            userAnswer: userAnswers[i] !== undefined ? questions[i].options[userAnswers[i]] : '–ù–µ –≤—ñ–¥–ø–æ–≤—ñ–≤',
            correctAnswer: questions[i].options[questions[i].correct],
            isCorrect: isCorrect
        });
    }
    
    showResults(score, timeSpent, results);
    
    fetch('/submit_test', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            score: score,
            total: questions.length,
            timeSpent: timeSpent,
            results: results
        })
    })
    .then(response => response.json())
    .then(data => {
        console.log('–†–µ–∑—É–ª—å—Ç–∞—Ç –∑–±–µ—Ä–µ–∂–µ–Ω–æ:', data);
    })
    .catch(error => {
        console.error('–ü–æ–º–∏–ª–∫–∞ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç—É:', error);
    });
}

function showResults(score, timeSpent, results) {
    document.getElementById('testContainer').style.display = 'none';
    document.getElementById('resultsContainer').style.display = 'block';
    
    const percentage = Math.round((score / questions.length) * 100);
    let grade = '';
    let badgeClass = '';
    
    if (percentage >= 90) {
        grade = '–í—ñ–¥–º—ñ–Ω–Ω–æ';
        badgeClass = 'bg-success';
    } else if (percentage >= 75) {
        grade = '–î–æ–±—Ä–µ';
        badgeClass = 'bg-info';
    } else if (percentage >= 60) {
        grade = '–ó–∞–¥–æ–≤—ñ–ª—å–Ω–æ';
        badgeClass = 'bg-warning';
    } else {
        grade = '–ù–µ–∑–∞–¥–æ–≤—ñ–ª—å–Ω–æ';
        badgeClass = 'bg-danger';
    }
    
    document.getElementById('scoreDisplay').innerHTML = `
        <div class="card">
            <div class="card-body text-center">
                <h1 class="display-4 text-primary">${score}/${questions.length}</h1>
                <h3><span class="badge ${badgeClass}">${grade} (${percentage}%)</span></h3>
                <p class="text-muted">–ß–∞—Å –≤–∏–∫–æ–Ω–∞–Ω–Ω—è: ${Math.floor(timeSpent / 60)}:${(timeSpent % 60).toString().padStart(2, '0')}</p>
            </div>
        </div>
    `;
    
    const detailedResultsHtml = `
        <div class="card">
            <div class="card-header">
                <h5>üìä –î–µ—Ç–∞–ª—å–Ω—ñ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∏</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>–ü—Ä–µ–¥–º–µ—Ç</th>
                                <th>–ó–∞–ø–∏—Ç–∞–Ω–Ω—è</th>
                                <th>–í–∞—à–∞ –≤—ñ–¥–ø–æ–≤—ñ–¥—å</th>
                                <th>–ü—Ä–∞–≤–∏–ª—å–Ω–∞ –≤—ñ–¥–ø–æ–≤—ñ–¥—å</th>
                                <th>–†–µ–∑—É–ª—å—Ç–∞—Ç</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${results.map((result, index) => `
                                <tr>
                                    <td><span class="badge bg-secondary">${result.subject}</span></td>
                                    <td>${result.question}</td>
                                    <td class="${result.isCorrect ? 'text-success' : 'text-danger'}">
                                        ${result.userAnswer}
                                    </td>
                                    <td class="text-success">${result.correctAnswer}</td>
                                    <td>
                                        ${result.isCorrect ? 
                                            '<span class="badge bg-success">‚úÖ</span>' : 
                                            '<span class="badge bg-danger">‚ùå</span>'
                                        }
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    `;
    
    document.getElementById('detailedResults').innerHTML = detailedResultsHtml;
}

function retakeTest() {
    document.getElementById('resultsContainer').style.display = 'none';
    document.getElementById('instructions').style.display = 'block';
    currentQuestion = 0;
    userAnswers = [];
}
</script>
{% endblock %}
