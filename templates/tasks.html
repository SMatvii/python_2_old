{% extends "base.html" %}

{% block title %}–ó–∞–≤–¥–∞–Ω–Ω—è - –®–∫—ñ–ª—å–Ω–∏–π —Ä–æ–∑–∫–ª–∞–¥{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2>üìù –ú–æ—ó –∑–∞–≤–¥–∞–Ω–Ω—è</h2>
    <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#addTaskModal">
        ‚ûï –î–æ–¥–∞—Ç–∏ –∑–∞–≤–¥–∞–Ω–Ω—è
    </button>
</div>

<div class="row">
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header">
                <h5>üìã –°–ø–∏—Å–æ–∫ –∑–∞–≤–¥–∞–Ω—å</h5>
            </div>
            <div class="card-body">
                {% if tasks %}
                    <div id="tasksContainer">
                        {% for task in tasks %}
                        <div class="card mb-3 task-item" data-task-id="{{ task.id }}">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div class="flex-grow-1">
                                        <h6 class="card-title">
                                            {% if task.completed %}
                                                <span class="text-decoration-line-through text-muted">{{ task.title }}</span>
                                                <span class="badge bg-success ms-2">‚úÖ –í–∏–∫–æ–Ω–∞–Ω–æ</span>
                                            {% else %}
                                                {{ task.title }}
                                                {% if task.due_date %}
                                                    {% set due_date = task.due_date|string %}
                                                    {% set today = moment().format('YYYY-MM-DD') %}
                                                    {% if due_date < today %}
                                                        <span class="badge bg-danger ms-2">‚è∞ –ü—Ä–æ—Å—Ç—Ä–æ—á–µ–Ω–æ</span>
                                                    {% elif due_date == today %}
                                                        <span class="badge bg-warning ms-2">üìÖ –°—å–æ–≥–æ–¥–Ω—ñ</span>
                                                    {% endif %}
                                                {% endif %}
                                            {% endif %}
                                        </h6>
                                        <p class="card-text">{{ task.description or '–ù–µ–º–∞—î –æ–ø–∏—Å—É' }}</p>
                                        <div class="d-flex gap-3">
                                            <small class="text-muted">üìö –ü—Ä–µ–¥–º–µ—Ç: {{ task.subject }}</small>
                                            {% if task.due_date %}
                                                <small class="text-muted">üìÖ –î–µ–¥–ª–∞–π–Ω: {{ task.due_date }}</small>
                                            {% endif %}
                                        </div>
                                    </div>
                                    <div class="dropdown">
                                        <button class="btn btn-sm btn-outline-secondary dropdown-toggle" 
                                                type="button" data-bs-toggle="dropdown">
                                            ‚öôÔ∏è
                                        </button>
                                        <ul class="dropdown-menu">
                                            {% if not task.completed %}
                                                <li><a class="dropdown-item" href="#" 
                                                       onclick="toggleTaskComplete({{ task.id }}, true)">
                                                    ‚úÖ –ü–æ–∑–Ω–∞—á–∏—Ç–∏ –≤–∏–∫–æ–Ω–∞–Ω–∏–º
                                                </a></li>
                                            {% else %}
                                                <li><a class="dropdown-item" href="#" 
                                                       onclick="toggleTaskComplete({{ task.id }}, false)">
                                                    ‚Ü©Ô∏è –ü–æ–≤–µ—Ä–Ω—É—Ç–∏ –≤ —Ä–æ–±–æ—Ç—É
                                                </a></li>
                                            {% endif %}
                                            <li><a class="dropdown-item" href="#" 
                                                   onclick="editTask({{ task.id }})">‚úèÔ∏è –†–µ–¥–∞–≥—É–≤–∞—Ç–∏</a></li>
                                            <li><hr class="dropdown-divider"></li>
                                            <li><a class="dropdown-item text-danger" href="#" 
                                                   onclick="deleteTask({{ task.id }})">üóëÔ∏è –í–∏–¥–∞–ª–∏—Ç–∏</a></li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <div class="text-center py-5">
                        <h4 class="text-muted">üì≠ –£ –≤–∞—Å –ø–æ–∫–∏ –Ω–µ–º–∞—î –∑–∞–≤–¥–∞–Ω—å</h4>
                        <p class="text-muted">–ù–∞—Ç–∏—Å–Ω—ñ—Ç—å –∫–Ω–æ–ø–∫—É "–î–æ–¥–∞—Ç–∏ –∑–∞–≤–¥–∞–Ω–Ω—è" —â–æ–± —Å—Ç–≤–æ—Ä–∏—Ç–∏ –ø–µ—Ä—à–µ –∑–∞–≤–¥–∞–Ω–Ω—è</p>
                        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addTaskModal">
                            ‚ûï –°—Ç–≤–æ—Ä–∏—Ç–∏ –ø–µ—Ä—à–µ –∑–∞–≤–¥–∞–Ω–Ω—è
                        </button>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
    
    <div class="col-lg-4">
        <div class="card">
            <div class="card-header">
                <h5>üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h5>
            </div>
            <div class="card-body">
                {% set total_tasks = tasks|length %}
                {% set completed_tasks = tasks|selectattr('completed')|list|length %}
                {% set pending_tasks = total_tasks - completed_tasks %}
                
                <div class="text-center">
                    <h3 class="text-primary">{{ total_tasks }}</h3>
                    <p class="mb-1">–í—Å—å–æ–≥–æ –∑–∞–≤–¥–∞–Ω—å</p>
                </div>
                
                <hr>
                
                <div class="row text-center">
                    <div class="col-6">
                        <h4 class="text-success">{{ completed_tasks }}</h4>
                        <small>–í–∏–∫–æ–Ω–∞–Ω–æ</small>
                    </div>
                    <div class="col-6">
                        <h4 class="text-warning">{{ pending_tasks }}</h4>
                        <small>–í —Ä–æ–±–æ—Ç—ñ</small>
                    </div>
                </div>
                
                {% if total_tasks > 0 %}
                <div class="mt-3">
                    <div class="progress">
                        {% set progress = (completed_tasks / total_tasks * 100)|round %}
                        <div class="progress-bar" role="progressbar" 
                             style="width: {{ progress }}%" 
                             aria-valuenow="{{ progress }}" 
                             aria-valuemin="0" aria-valuemax="100">
                            {{ progress }}%
                        </div>
                    </div>
                    <small class="text-muted">–ü—Ä–æ–≥—Ä–µ—Å –≤–∏–∫–æ–Ω–∞–Ω–Ω—è</small>
                </div>
                {% endif %}
            </div>
        </div>
        
        <div class="card mt-3">
            <div class="card-header">
                <h5>üí° –ü–æ—Ä–∞–¥–∏</h5>
            </div>
            <div class="card-body">
                <ul class="list-unstyled">
                    <li class="mb-2">üìÖ –í—Å—Ç–∞–Ω–æ–≤–ª—é–π—Ç–µ —Ä–µ–∞–ª—å–Ω—ñ –¥–µ–¥–ª–∞–π–Ω–∏</li>
                    <li class="mb-2">üìù –î–æ–¥–∞–≤–∞–π—Ç–µ –¥–µ—Ç–∞–ª—å–Ω–∏–π –æ–ø–∏—Å –∑–∞–≤–¥–∞–Ω—å</li>
                    <li class="mb-2">üè∑Ô∏è –ì—Ä—É–ø—É–π—Ç–µ –∑–∞–≤–¥–∞–Ω–Ω—è –∑–∞ –ø—Ä–µ–¥–º–µ—Ç–∞–º–∏</li>
                    <li class="mb-2">‚úÖ –†–µ–≥—É–ª—è—Ä–Ω–æ –≤—ñ–¥–º—ñ—á–∞–π—Ç–µ –≤–∏–∫–æ–Ω–∞–Ω—ñ –∑–∞–≤–¥–∞–Ω–Ω—è</li>
                </ul>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="addTaskModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">‚ûï –î–æ–¥–∞—Ç–∏ –Ω–æ–≤–µ –∑–∞–≤–¥–∞–Ω–Ω—è</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addTaskForm">
                    <div class="mb-3">
                        <label for="taskTitle" class="form-label">–ù–∞–∑–≤–∞ –∑–∞–≤–¥–∞–Ω–Ω—è</label>
                        <input type="text" class="form-control" id="taskTitle" required>
                    </div>
                    
                    <div class="mb-3">
                        <label for="taskDescription" class="form-label">–û–ø–∏—Å</label>
                        <textarea class="form-control" id="taskDescription" rows="3"></textarea>
                    </div>
                    
                    <div class="mb-3">
                        <label for="taskSubject" class="form-label">–ü—Ä–µ–¥–º–µ—Ç</label>
                        <select class="form-select" id="taskSubject" required>
                            <option value="">–û–±–µ—Ä—ñ—Ç—å –ø—Ä–µ–¥–º–µ—Ç</option>
                            <option value="–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞">üìê –ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞</option>
                            <option value="–£–∫—Ä–∞—ó–Ω—Å—å–∫–∞ –º–æ–≤–∞">üìù –£–∫—Ä–∞—ó–Ω—Å—å–∫–∞ –º–æ–≤–∞</option>
                            <option value="–ê–Ω–≥–ª—ñ–π—Å—å–∫–∞ –º–æ–≤–∞">üåç –ê–Ω–≥–ª—ñ–π—Å—å–∫–∞ –º–æ–≤–∞</option>
                            <option value="–§—ñ–∑–∏–∫–∞">‚ö° –§—ñ–∑–∏–∫–∞</option>
                            <option value="–•—ñ–º—ñ—è">üß™ –•—ñ–º—ñ—è</option>
                            <option value="–ë—ñ–æ–ª–æ–≥—ñ—è">üå± –ë—ñ–æ–ª–æ–≥—ñ—è</option>
                            <option value="–ì–µ–æ–≥—Ä–∞—Ñ—ñ—è">üåç –ì–µ–æ–≥—Ä–∞—Ñ—ñ—è</option>
                            <option value="–Ü—Å—Ç–æ—Ä—ñ—è">üìö –Ü—Å—Ç–æ—Ä—ñ—è</option>
                            <option value="–Ü–Ω—Ñ–æ—Ä–º–∞—Ç–∏–∫–∞">üíª –Ü–Ω—Ñ–æ—Ä–º–∞—Ç–∏–∫–∞</option>
                            <option value="–Ü–Ω—à–µ">üìã –Ü–Ω—à–µ</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="taskDueDate" class="form-label">–î–µ–¥–ª–∞–π–Ω</label>
                        <input type="date" class="form-control" id="taskDueDate">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
                <button type="button" class="btn btn-success" onclick="addTask()">–î–æ–¥–∞—Ç–∏ –∑–∞–≤–¥–∞–Ω–Ω—è</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function addTask() {
    const title = document.getElementById('taskTitle').value;
    const description = document.getElementById('taskDescription').value;
    const subject = document.getElementById('taskSubject').value;
    const dueDate = document.getElementById('taskDueDate').value;
    
    if (!title || !subject) {
        alert('–ë—É–¥—å –ª–∞—Å–∫–∞, –∑–∞–ø–æ–≤–Ω—ñ—Ç—å –æ–±–æ–≤\'—è–∑–∫–æ–≤—ñ –ø–æ–ª—è');
        return;
    }
    
    fetch('/add_task', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            title: title,
            description: description,
            subject: subject,
            due_date: dueDate
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert('–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –¥–æ–¥–∞–≤–∞–Ω–Ω—ñ –∑–∞–≤–¥–∞–Ω–Ω—è');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –¥–æ–¥–∞–≤–∞–Ω–Ω—ñ –∑–∞–≤–¥–∞–Ω–Ω—è');
    });
}

function deleteTask(taskId) {
    if (confirm('–í–∏ –≤–ø–µ–≤–Ω–µ–Ω—ñ, —â–æ —Ö–æ—á–µ—Ç–µ –≤–∏–¥–∞–ª–∏—Ç–∏ —Ü–µ –∑–∞–≤–¥–∞–Ω–Ω—è?')) {
        fetch(`/delete_task/${taskId}`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const taskElement = document.querySelector(`[data-task-id="${taskId}"]`);
                if (taskElement) {
                    taskElement.remove();
                }
                
                const tasks = JSON.parse(localStorage.getItem('tasks') || '[]');
                const updatedTasks = tasks.filter(task => task.id !== taskId);
                localStorage.setItem('tasks', JSON.stringify(updatedTasks));
                
                location.reload();
            } else {
                alert('–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –≤–∏–¥–∞–ª–µ–Ω–Ω—ñ –∑–∞–≤–¥–∞–Ω–Ω—è');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –≤–∏–¥–∞–ª–µ–Ω–Ω—ñ –∑–∞–≤–¥–∞–Ω–Ω—è');
        });
    }
}

function toggleTaskComplete(taskId, completed) {
    console.log(`–ó–∞–≤–¥–∞–Ω–Ω—è ${taskId} ${completed ? '–≤–∏–∫–æ–Ω–∞–Ω–æ' : '–ø–æ–≤–µ—Ä–Ω—É—Ç–æ –≤ —Ä–æ–±–æ—Ç—É'}`);
    location.reload();
}

function editTask(taskId) {
    alert('–§—É–Ω–∫—Ü—ñ—è —Ä–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è –±—É–¥–µ –¥–æ–¥–∞–Ω–∞ –≤ –Ω–∞—Å—Ç—É–ø–Ω–∏—Ö –≤–µ—Ä—Å—ñ—è—Ö');
}

document.getElementById('taskDueDate').min = new Date().toISOString().split('T')[0];
</script>
{% endblock %}
